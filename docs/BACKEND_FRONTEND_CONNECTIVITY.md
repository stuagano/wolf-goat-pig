# Backend/Frontend Connectivity Guide

Complete guide to ensuring reliable communication between the Wolf Goat Pig backend and frontend across all environments.

## Table of Contents

- [Overview](#overview)
- [How It Works](#how-it-works)
- [Smart API Configuration](#smart-api-configuration)
- [Environment Setup](#environment-setup)
- [Vercel Configuration](#vercel-configuration)
- [Troubleshooting](#troubleshooting)
- [Verification](#verification)

---

## Overview

The Wolf Goat Pig application uses a **smart runtime API configuration** that automatically detects the appropriate backend URL based on the deployment environment.

### Architecture

```
┌─────────────────────────────────────────┐
│  Environment Detection Flow              │
│                                           │
│  1. Check REACT_APP_API_URL              │
│     ├─ Set? → Use it                     │
│     └─ Not set? → Continue to #2         │
│                                           │
│  2. Check window.location.hostname       │
│     ├─ localhost? → http://localhost:8000│
│     ├─ vercel.app? → Render production   │
│     └─ Other? → Use fallback             │
│                                           │
│  3. Fallback: Production URL             │
│     └─ https://wolf-goat-pig.onrender.com│
└─────────────────────────────────────────┘
```

---

## How It Works

### 1. Smart API Configuration (`frontend/src/config/api.config.js`)

The frontend uses a **runtime detection system** instead of relying solely on build-time environment variables:

```javascript
// Priority 1: Environment variable (preferred)
const envApiUrl = process.env.REACT_APP_API_URL;

// Priority 2: Runtime hostname detection
if (hostname === 'localhost') {
  return 'http://localhost:8000';  // Local development
}
if (hostname.includes('vercel.app')) {
  return 'https://wolf-goat-pig.onrender.com';  // Production
}

// Priority 3: Fallback
return 'https://wolf-goat-pig.onrender.com';
```

### 2. API Utilities (`frontend/src/utils/api.js`)

All API calls use the smart configuration:

```javascript
import apiConfig from '../config/api.config';

const API_URL = apiConfig.baseUrl;  // Auto-detected URL

// API calls with retry logic and error handling
export const apiGet = async (endpoint, retries = 3) => {
  const response = await apiCall(`${API_URL}${endpoint}`, { method: 'GET' }, retries);
  return response.json();
};
```

### 3. CORS Configuration (`backend/app/main.py`)

Backend allows requests from configured origins:

```python
allowed_origins = [
    "https://wolf-goat-pig.vercel.app",  # Production
    # Localhost automatically added in development
]

if os.getenv("ENVIRONMENT") != "production" or "localhost" in os.getenv("FRONTEND_URL", ""):
    allowed_origins.extend([
        "http://localhost:3000",
        "http://localhost:3001",
    ])
```

---

## Environment Setup

### Local Development

#### Frontend (`.env.local`)

```bash
# Leave API_URL empty - uses proxy from package.json
REACT_APP_API_URL=

# Auth0 (if needed)
REACT_APP_AUTH0_DOMAIN=dev-jm88n088hpt7oe48.us.auth0.com
REACT_APP_AUTH0_CLIENT_ID=qAZuRv5E9mPQ9uTGg7NWpkpfVj8bCeoB
REACT_APP_USE_MOCK_AUTH=true

# Dev server port
PORT=3001
```

#### Backend (`.env`)

```bash
# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/wolf_goat_pig

# Environment
ENVIRONMENT=development

# Frontend URL
FRONTEND_URL=http://localhost:3000

# Secret
SECRET_KEY=dev-secret-key
```

#### How It Works Locally

1. Frontend uses proxy from `package.json`: `"proxy": "http://localhost:8000"`
2. API calls to `/api/players` → proxied to `http://localhost:8000/api/players`
3. Backend CORS allows `localhost:3000` automatically
4. No REACT_APP_API_URL needed!

---

### Production (Vercel + Render)

#### Critical: Vercel Environment Variables

**The `.env.production` file is NOT automatically used by Vercel!**

You **MUST** set environment variables in the Vercel dashboard:

1. Go to your project in Vercel
2. Settings → Environment Variables
3. Add these variables:

```bash
# REQUIRED - Backend URL
REACT_APP_API_URL=https://wolf-goat-pig.onrender.com

# Auth0
REACT_APP_AUTH0_DOMAIN=dev-jm88n088hpt7oe48.us.auth0.com
REACT_APP_AUTH0_CLIENT_ID=qAZuRv5E9mPQ9uTGg7NWpkpfVj8bCeoB
REACT_APP_AUTH0_AUDIENCE=https://api.wolf-goat-pig.com
REACT_APP_USE_MOCK_AUTH=false

# Feature flags
REACT_APP_ENABLE_ANALYTICS=true
REACT_APP_SIMULATION_USE_MOCKS=false
REACT_APP_DEPLOY_PLATFORM=vercel
```

**Environment Scope**: Select all three: Production, Preview, Development

4. **Redeploy** after adding variables!

#### Render Environment Variables

```bash
# Auto-provided by Render PostgreSQL service
DATABASE_URL=<auto-generated>

# Set these manually
ENVIRONMENT=production
FRONTEND_URL=https://wolf-goat-pig.vercel.app
SECRET_KEY=<generate-with-openssl-rand-hex-32>

# Auth0 (if using)
AUTH0_DOMAIN=dev-jm88n088hpt7oe48.us.auth0.com
AUTH0_AUDIENCE=https://api.wolf-goat-pig.com
```

---

## Vercel Configuration

### Option 1: Dashboard (Recommended)

Set environment variables as shown above.

### Option 2: vercel.json (Alternative)

The project includes `frontend/vercel.json` with default values:

```json
{
  "build": {
    "env": {
      "REACT_APP_API_URL": "https://wolf-goat-pig.onrender.com",
      "REACT_APP_AUTH0_DOMAIN": "dev-jm88n088hpt7oe48.us.auth0.com",
      "REACT_APP_AUTH0_CLIENT_ID": "qAZuRv5E9mPQ9uTGg7NWpkpfVj8bCeoB",
      "REACT_APP_AUTH0_AUDIENCE": "https://api.wolf-goat-pig.com",
      "REACT_APP_USE_MOCK_AUTH": "false"
    }
  }
}
```

**Note**: Dashboard variables override `vercel.json` values.

---

## Troubleshooting

### Problem: Frontend stuck on "Hold On Please..."

**Cause:** Frontend cannot reach backend

**Diagnosis:**
```bash
# Check console logs in browser
# Look for errors like:
# - "Failed to fetch"
# - "CORS error"
# - "Network request failed"

# Check network tab in DevTools
# Look for failed requests to /api/* endpoints
```

**Solutions:**

1. **Verify Vercel has REACT_APP_API_URL set**
   ```bash
   # In Vercel dashboard → Settings → Environment Variables
   # Should see: REACT_APP_API_URL = https://wolf-goat-pig.onrender.com
   ```

2. **Verify backend is running**
   ```bash
   curl https://wolf-goat-pig.onrender.com/health
   # Should return: {"status":"ok","timestamp":"..."}
   ```

3. **Verify CORS configuration**
   ```bash
   curl -I -H "Origin: https://wolf-goat-pig.vercel.app" \
     -H "Access-Control-Request-Method: GET" \
     -X OPTIONS \
     https://wolf-goat-pig.onrender.com/health

   # Should include header:
   # access-control-allow-origin: https://wolf-goat-pig.vercel.app
   ```

4. **Check Render environment variables**
   ```bash
   # In Render dashboard → Environment
   # Verify: FRONTEND_URL = https://wolf-goat-pig.vercel.app
   ```

5. **Redeploy both services**
   ```bash
   # After changing environment variables, redeploy!
   # Vercel: Deployments → Latest → Redeploy
   # Render: Manual Deploy → Deploy latest commit
   ```

---

### Problem: CORS errors in browser console

**Error Message:**
```
Access to fetch at 'https://wolf-goat-pig.onrender.com/api/...'
from origin 'https://wolf-goat-pig.vercel.app' has been blocked by CORS policy
```

**Solutions:**

1. **Check backend CORS configuration** (`backend/app/main.py:167-180`)
   ```python
   # Verify Vercel domain is included
   allowed_origins = [
       "https://wolf-goat-pig.vercel.app",  # ← Should be here
   ]
   ```

2. **Check Render FRONTEND_URL environment variable**
   ```bash
   # Should match your Vercel deployment URL exactly
   FRONTEND_URL=https://wolf-goat-pig.vercel.app
   ```

3. **Redeploy backend after CORS changes**

---

### Problem: Local development - "Failed to fetch"

**Solutions:**

1. **Verify backend is running**
   ```bash
   # Start backend
   cd backend
   source venv/bin/activate
   uvicorn app.main:app --reload --port 8000

   # Test health
   curl http://localhost:8000/health
   ```

2. **Verify proxy configuration** (`frontend/package.json`)
   ```json
   {
     "proxy": "http://localhost:8000"  // ← Should be present
   }
   ```

3. **Restart frontend dev server**
   ```bash
   # Proxy changes require restart
   cd frontend
   npm start
   ```

4. **Check .env.local doesn't override**
   ```bash
   # Should be empty or not set
   REACT_APP_API_URL=
   ```

---

### Problem: Environment variables not updating

**Cause:** Vercel caches builds, React bakes env vars at build time

**Solutions:**

1. **After changing environment variables in Vercel:**
   - Go to Deployments
   - Click on latest deployment
   - Click "Redeploy"

2. **Clear build cache (if needed):**
   ```bash
   # In project root
   rm -rf frontend/.next
   rm -rf frontend/build
   ```

3. **Verify variables are set:**
   - Check Vercel dashboard → Settings → Environment Variables
   - Ensure they're set for all environments (Production, Preview, Development)

---

## Verification

### Automated Verification Scripts

#### Production Deployment
```bash
./scripts/verify-deployment.sh

# With custom URLs
BACKEND_URL=https://your-backend.onrender.com \
FRONTEND_URL=https://your-frontend.vercel.app \
./scripts/verify-deployment.sh
```

**Tests:**
- ✅ Backend health endpoint
- ✅ Backend CORS configuration
- ✅ Frontend accessibility
- ✅ Cross-origin communication

#### Local Development
```bash
./scripts/test-local-connectivity.sh
```

**Tests:**
- ✅ Backend running on localhost:8000
- ✅ Frontend running on localhost:3000
- ✅ API endpoints responding
- ✅ CORS configured for localhost

---

### Manual Verification

#### 1. Check Frontend API Configuration

Open browser console on your Vercel deployment:

```javascript
// Should see logs like:
[API Config] Using REACT_APP_API_URL: https://wolf-goat-pig.onrender.com
[API Config] Configuration: {
  baseUrl: "https://wolf-goat-pig.onrender.com",
  isDevelopment: false,
  isProduction: true,
  platform: "vercel"
}
```

#### 2. Test API Call

In browser console:

```javascript
fetch('https://wolf-goat-pig.onrender.com/health')
  .then(r => r.json())
  .then(console.log)
// Should see: {status: "ok", timestamp: "..."}
```

#### 3. Check CORS Headers

In browser DevTools → Network tab:
- Open network panel
- Trigger an API request
- Click on the request
- Check Response Headers:
  - Should include: `access-control-allow-origin: https://wolf-goat-pig.vercel.app`

---

## Deployment Checklist

### Pre-Deployment

- [ ] Backend deployed to Render
- [ ] PostgreSQL database created
- [ ] Backend environment variables set (FRONTEND_URL, ENVIRONMENT, SECRET_KEY)
- [ ] Backend health check passes: `curl https://<backend>.onrender.com/health`

### Vercel Deployment

- [ ] Frontend code pushed to GitHub
- [ ] Vercel project created and linked to repo
- [ ] Environment variables set in Vercel dashboard (especially REACT_APP_API_URL)
- [ ] Initial deployment triggered
- [ ] Frontend loads without errors
- [ ] Browser console shows correct API configuration

### Post-Deployment

- [ ] Run `./scripts/verify-deployment.sh`
- [ ] Test login flow
- [ ] Test API calls from frontend
- [ ] Check browser console for errors
- [ ] Check Render logs for errors
- [ ] Verify CORS working (no errors in console)

### If Issues Occur

1. Check browser console for errors
2. Check Vercel deployment logs
3. Check Render backend logs
4. Verify all environment variables
5. Run verification scripts
6. Redeploy both services if needed

---

## Key Takeaways

1. **Vercel environment variables MUST be set in the dashboard** - `.env.production` is not enough
2. **Backend FRONTEND_URL must match your Vercel deployment URL exactly**
3. **Redeploy after changing environment variables**
4. **Use verification scripts to test connectivity**
5. **Check browser console and network tab for debugging**

---

## Additional Resources

- [Main Deployment Guide](./DEPLOYMENT.md)
- [Vercel Environment Variables Documentation](https://vercel.com/docs/concepts/projects/environment-variables)
- [Render Environment Variables Documentation](https://render.com/docs/configure-environment-variables)
- [FastAPI CORS Documentation](https://fastapi.tiangolo.com/tutorial/cors/)

---

**Last Updated:** 2025-01-24

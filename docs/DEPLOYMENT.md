# Wolf Goat Pig Deployment Guide

This guide covers deploying the Wolf Goat Pig application to Render (backend) and Vercel (frontend), including automated deployment bots and validation.

## Environment Variables

### Critical Environment Variables Overview

**‚ö†Ô∏è IMPORTANT**: React environment variables (prefixed with `REACT_APP_`) are **baked into the build at compile time**. They must be set in the Vercel dashboard **before building**, not at runtime.

### Local Development
For local development, the frontend uses the proxy configuration in `package.json`:
```json
"proxy": "http://localhost:8000"
```

This means `API_URL` will be empty and requests will be proxied to `http://localhost:8000`.

### Production Deployment - Required Environment Variables

#### **Vercel (Frontend) - REQUIRED**

These **MUST** be set in your Vercel project dashboard (Settings ‚Üí Environment Variables) for **all environments** (Production, Preview, Development):

| Variable | Value | Required | Description |
|----------|-------|----------|-------------|
| `REACT_APP_API_URL` | `https://wolf-goat-pig.onrender.com` | ‚úÖ YES | Backend API URL - **CRITICAL** |
| `REACT_APP_AUTH0_DOMAIN` | `dev-jm88n088hpt7oe48.us.auth0.com` | ‚úÖ YES | Auth0 tenant domain |
| `REACT_APP_AUTH0_CLIENT_ID` | `qAZuRv5E9mPQ9uTGg7NWpkpfVj8bCeoB` | ‚úÖ YES | Auth0 application client ID |
| `REACT_APP_AUTH0_AUDIENCE` | `https://api.wolf-goat-pig.com` | ‚úÖ YES | Auth0 API audience |
| `REACT_APP_USE_MOCK_AUTH` | `false` | ‚úÖ YES | Disable mock auth in production |
| `REACT_APP_ENABLE_ANALYTICS` | `true` | ‚ö™ Optional | Enable analytics tracking |
| `REACT_APP_DEPLOY_PLATFORM` | `vercel` | ‚ö™ Optional | Deployment platform identifier |

**üìù How to set in Vercel:**
1. Go to https://vercel.com/your-username/wolf-goat-pig/settings/environment-variables
2. Add each variable above
3. Select all three environments: Production, Preview, Development
4. Click "Save"
5. Redeploy your application

#### **Render (Backend) - REQUIRED**

These are automatically set via `render.yaml` but can be overridden in the Render dashboard:

| Variable | Value | Required | Description |
|----------|-------|----------|-------------|
| `DATABASE_URL` | Auto-generated by Render | ‚úÖ YES | PostgreSQL connection string |
| `ENVIRONMENT` | `production` | ‚úÖ YES | Application environment |
| `FRONTEND_URL` | `https://wolf-goat-pig.vercel.app` | ‚úÖ YES | Frontend URL for CORS |
| `BACKEND_URL` | `https://wolf-goat-pig.onrender.com` | ‚úÖ YES | Backend API URL |
| `AUTH0_DOMAIN` | `dev-jm88n088hpt7oe48.us.auth0.com` | ‚úÖ YES | Auth0 tenant domain |
| `AUTH0_API_AUDIENCE` | `https://wolf-goat-pig.onrender.com` | ‚úÖ YES | Auth0 API audience |
| `AUTH0_CLIENT_ID` | `qAZuRv5E9mPQ9uTGg7NWpkpfVj8bCeoB` | ‚úÖ YES | Auth0 client ID |
| `AUTH0_CLIENT_SECRET` | *Set in dashboard* | ‚úÖ YES | Auth0 client secret (sensitive) |
| `PYTHON_VERSION` | `3.12.8` | ‚úÖ YES | Python runtime version |

#### **Optional Backend Variables**

| Variable | Default | Description |
|----------|---------|-------------|
| `ENABLE_GHIN_INTEGRATION` | `false` | Enable GHIN handicap integration |
| `GHIN_API_USER` | `""` | GHIN API username (if integration enabled) |
| `GHIN_API_PASS` | `""` | GHIN API password (if integration enabled) |
| `GHIN_API_STATIC_TOKEN` | `""` | GHIN static token (if integration enabled) |
| `ENABLE_EMAIL_NOTIFICATIONS` | `false` | Enable email notifications |
| `SMTP_HOST` | - | SMTP server for email |
| `SMTP_PORT` | `587` | SMTP port |
| `SMTP_USER` | - | SMTP username |
| `SMTP_PASSWORD` | - | SMTP password |
| `FROM_EMAIL` | - | Email sender address |

### Environment Variable Configuration

The frontend uses `API_URL = process.env.REACT_APP_API_URL || ""` for all API calls.

- **Local Development**: `API_URL` is empty, uses proxy
- **Production**: `API_URL` points to Render backend

### Docker Compose (Local Production Testing)

For `docker-compose.prod.yml`, you can override environment variables:

```bash
# Set variables before running docker-compose
export REACT_APP_API_URL=http://localhost:8000
export FRONTEND_URL=http://localhost:3000
docker-compose -f docker-compose.prod.yml up --build
```

Or create a `.env` file in the root directory:
```env
REACT_APP_API_URL=http://localhost:8000
FRONTEND_URL=http://localhost:3000
GHIN_API_USER=your-email
GHIN_API_PASS=your-password
JWT_SECRET=your-secret-key
```

## CORS Configuration

The backend has been configured to allow all origins without CORS restrictions. No additional CORS configuration is needed on the frontend.

## Deployment Steps

1. **Set Environment Variables** in Vercel dashboard
2. **Deploy** - Vercel will automatically build and deploy when you push to GitHub
3. **Verify** - Check that the frontend can communicate with the backend

## üöÄ Render (Backend) Deployment

### Configuration
The backend is configured using `render.yaml` in the root directory:
- **Database**: PostgreSQL (free tier) with persistent disk storage
- **API Service**: Python 3.12.8 with FastAPI
- **Health Check**: `/health` endpoint
- **Environment**: Production with proper variables
- **Auto Deploy**: Enabled on git push
- **Database Init**: Automatic initialization on startup

### Key Features
- ‚úÖ Automatic database initialization via `init_db()`
- ‚úÖ Persistent disk storage (1GB) at `/opt/render/project/src/data`
- ‚úÖ Health check monitoring every 30s
- ‚úÖ All environment variables pre-configured in `render.yaml`
- ‚úÖ Uses newer `fromService` syntax for database connection

### Deployment Process
1. Connect your GitHub repository to Render
2. Create a **New Blueprint Instance** using `render.yaml`
3. **Important**: Set `AUTH0_CLIENT_SECRET` in Render dashboard (not in render.yaml for security)
4. Render will automatically:
   - Create PostgreSQL database
   - Build backend from `backend/` directory
   - Set all environment variables
   - Deploy and start the service
5. Subsequent deploys happen automatically on git push to main branch

## üîó Vercel (Frontend) Deployment

### Configuration
The frontend is configured using `frontend/vercel.json`:
- **Framework**: Create React App (auto-detected)
- **Build**: Optimized production build with npm ci
- **Output**: Static build artifacts from `build/` directory
- **Static Files**: Aggressive caching (1 year for static assets)
- **Security**: Comprehensive security headers (X-Frame-Options, X-Content-Type-Options, CSP, Referrer-Policy)
- **Routing**: SPA routing with fallback to index.html for client-side routing

### Required Environment Variables
‚ö†Ô∏è **CRITICAL**: All variables listed in the "Vercel (Frontend) - REQUIRED" section above **MUST** be set in your Vercel dashboard **before deployment**. Missing variables will cause API calls to fail.

### Deployment Process
1. Connect your GitHub repository to Vercel
2. Vercel will auto-detect the `frontend/` directory
3. **BEFORE first deploy**: Set all required environment variables in Vercel dashboard
4. Import project and Vercel will:
   - Use `frontend/vercel.json` configuration
   - Run `npm run build` in the frontend directory
   - Deploy static assets with proper caching and security headers
5. Subsequent deploys happen automatically on git push to main branch
6. Preview deployments are created for all pull requests

### Post-Deployment Verification
After deployment, verify:
- ‚úÖ Frontend loads at `https://wolf-goat-pig.vercel.app`
- ‚úÖ API calls reach `https://wolf-goat-pig.onrender.com`
- ‚úÖ Auth0 login works correctly
- ‚úÖ No console errors about missing environment variables

## ü§ñ Deployment Bots & Validation

### GitHub Actions Workflow
Automated deployment validation runs via `.github/workflows/deployment-validation.yml`:
- **Triggers**: Push to main, PRs, daily schedule
- **Validation**: Tests both Render and Vercel deployments
- **Health Checks**: Verifies all endpoints and functionality
- **Notifications**: Reports status in PR comments and job summaries

### Manual Validation
Run deployment validation manually:
```bash
# Validate both deployments
python scripts/deployment/validate_deployments.py

# Custom URLs
python scripts/deployment/validate_deployments.py \
  --backend "https://your-backend.onrender.com" \
  --frontend "https://your-frontend.vercel.app"

# JSON output
python scripts/deployment/validate_deployments.py --output json
```

### Validation Checks
**Backend (Render):**
- ‚úÖ Health endpoint (`/health`)
- ‚úÖ API documentation (`/docs`)
- ‚úÖ CORS configuration
- ‚úÖ Database connectivity
- ‚úÖ Component health status

**Frontend (Vercel):**
- ‚úÖ Main page loads
- ‚úÖ Static assets accessible
- ‚úÖ Security headers configured
- ‚úÖ React app initialization

**Integration:**
- ‚úÖ Frontend-backend connectivity
- ‚úÖ API endpoint accessibility
- ‚úÖ Environment configuration

## üîß Configuration Files

### `config/render.yaml`
```yaml
services:
  - type: pserv
    name: wolf-goat-pig-db
    env: postgresql
    
  - type: web
    name: wolf-goat-pig-api
    env: python
    startCommand: |
      cd backend && python -c "from app.database import init_db; init_db()" && 
      uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 1
    healthCheckPath: /health
```

### `config/vercel.json`
```json
{
  "builds": [{
    "src": "frontend/package.json",
    "use": "@vercel/static-build",
    "config": {
      "distDir": "build",
      "buildCommand": "cd frontend && npm ci --only=production && npm run build"
    }
  }],
  "env": {
    "REACT_APP_API_URL": "https://wolf-goat-pig-api.onrender.com"
  }
}
```

## üìä Monitoring & Status

### Health Endpoints
- **Backend Health**: `https://wolf-goat-pig-api.onrender.com/health`
- **Frontend Status**: `https://wolf-goat-pig.vercel.app`

### GitHub Actions Status
Check deployment validation status in:
- Repository Actions tab
- PR comments (for automated validation)
- Job summaries with detailed results

### Render Dashboard
Monitor backend deployment:
- Build logs and status
- Performance metrics
- Database health
- Environment variables

### Vercel Dashboard  
Monitor frontend deployment:
- Build status and logs
- Analytics and performance
- Domain configuration
- Environment variables

## üö® Troubleshooting

### Backend Issues
**Health Check Failures:**
1. Check Render logs for startup errors
2. Verify database connection string
3. Ensure all required environment variables are set
4. Check Python dependencies in `requirements.txt`

**Import/Module Errors:**
1. Verify the `startCommand` in `render.yaml`
2. Check Python path configuration
3. Ensure all app modules are properly structured

### Frontend Issues  
**Build Failures:**
1. Check Node.js version compatibility
2. Verify all dependencies in `package.json`
3. Check build command in `vercel.json`

**API Connection Issues:**
1. Verify `REACT_APP_API_URL` environment variable
2. Check CORS configuration on backend
3. Ensure backend is accessible from frontend

### CORS Errors
1. Verify the `REACT_APP_API_URL` environment variable is set correctly in Vercel
2. Check that the backend is running on Render
3. Ensure the backend URL is accessible
4. Check backend CORS middleware configuration

### Deployment Bot Issues
**GitHub Actions Failures:**
1. Check workflow permissions
2. Verify script dependencies
3. Review validation script logs
4. Check deployment URLs are accessible

**Validation Script Issues:**
1. Install required dependencies: `pip install requests`
2. Check network connectivity to deployment URLs
3. Verify URL formats are correct 
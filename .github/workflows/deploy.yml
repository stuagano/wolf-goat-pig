name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5

    - name: Trigger Render Deploy
      env:
        RENDER_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
      run: |
        if [ -z "$RENDER_HOOK" ]; then
          echo "âš ï¸ RENDER_DEPLOY_HOOK_URL secret not set - skipping"
          exit 0
        fi
        echo "ğŸš€ Triggering Render backend deployment..."
        curl -X POST "$RENDER_HOOK" \
          --fail \
          --silent \
          --show-error \
          -o /dev/null \
          -w "HTTP Status: %{http_code}\n"
        echo "âœ… Render deploy triggered"

    - name: Trigger Vercel Deploy
      env:
        VERCEL_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
      run: |
        if [ -z "$VERCEL_HOOK" ]; then
          echo "âš ï¸ VERCEL_DEPLOY_HOOK_URL secret not set - skipping"
          exit 0
        fi
        echo "ğŸ“¦ Triggering Vercel frontend deployment..."
        curl -X POST "$VERCEL_HOOK" \
          --fail \
          --silent \
          --show-error \
          -o /dev/null \
          -w "HTTP Status: %{http_code}\n"
        echo "âœ… Vercel deploy triggered"

    - name: Wait for deployments to start
      run: |
        echo "â³ Waiting 30 seconds for deployments to initialize..."
        sleep 30

    - name: Verify Render Backend Health
      run: |
        echo "ğŸ” Checking Render backend health..."
        MAX_RETRIES=20
        RETRY_DELAY=15

        for i in $(seq 1 $MAX_RETRIES); do
          echo "Attempt $i/$MAX_RETRIES..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://wolf-goat-pig.onrender.com/ready" \
            --max-time 10 || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Render backend is healthy!"
            break
          fi

          if [ $i -eq $MAX_RETRIES ]; then
            echo "âš ï¸ Render backend not ready after $MAX_RETRIES attempts"
            echo "   This may be normal for free tier cold starts (up to 5 min)"
            exit 0  # Don't fail - free tier can be slow
          fi

          echo "   Status: $HTTP_STATUS - waiting ${RETRY_DELAY}s..."
          sleep $RETRY_DELAY
        done

    - name: Verify Vercel Frontend Health
      run: |
        echo "ğŸ” Checking Vercel frontend health..."
        MAX_RETRIES=10
        RETRY_DELAY=10

        for i in $(seq 1 $MAX_RETRIES); do
          echo "Attempt $i/$MAX_RETRIES..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://wolf-goat-pig.vercel.app" \
            --max-time 10 || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Vercel frontend is healthy!"
            break
          fi

          if [ $i -eq $MAX_RETRIES ]; then
            echo "âš ï¸ Vercel frontend not ready after $MAX_RETRIES attempts"
            exit 0  # Don't fail - may still be deploying
          fi

          echo "   Status: $HTTP_STATUS - waiting ${RETRY_DELAY}s..."
          sleep $RETRY_DELAY
        done

    - name: Deployment Summary
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "              DEPLOYMENT COMPLETE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸŒ Frontend: https://wolf-goat-pig.vercel.app"
        echo "ğŸ”§ Backend:  https://wolf-goat-pig.onrender.com"
        echo ""
        echo "ğŸ“ Note: Free tier services may take 1-5 min to fully deploy"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
